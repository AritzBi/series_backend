"use strict";angular.module("serieFrontendApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ui.bootstrap","ui.router","googleplus","btford.socket-io","ngToast"]).config(["$stateProvider","$urlRouterProvider",function(a,b){a.state("home",{url:"/",templateUrl:"views/main.html",controller:"MainCtrl"}).state("series",{url:"/series",templateUrl:"views/series.html",controller:"SeriesCtrl"}).state("serieInfo",{url:"/serieInfo/{id}",templateUrl:"views/episodes.html",controller:"EpisodesCtrl"}).state("login",{url:"login",templateUrl:"views/login.html",controller:"LoginCtrl"}).state("profile",{url:"profile",templateUrl:"views/profile.html",controller:"ProfileCtrl"}).state("episode",{url:"episode/{_id}",templateUrl:"views/episode.html",controller:"EpisodeCtrl"}).state("favorites",{url:"favorites",templateUrl:"views/favorites.html",controller:"FavoritesCtrl"}),b.otherwise("/")}]).factory("mySocket",["socketFactory",function(a){var b=io.connect("http://pythontest-aritzbi.rhcloud.com/test"),c=a({ioSocket:b});return c.forward("notification"),c}]).directive("disableAnimation",["$animate",function(a){return{restrict:"A",link:function(b,c,d){d.$observe("disableAnimation",function(b){a.enabled(!b,c)})}}}]).config(["GooglePlusProvider",function(a){a.init({clientId:"149439254149-9u3dae6ug4qjsl6blhplgeq5sjbh5od0.apps.googleusercontent.com",apiKey:"AIzaSyCt0yTDMy4ks5yzHFD80wI9Pc-hQbDOrV4"})}]),angular.module("serieFrontendApp").controller("MainCtrl",["$scope","Auth","mySocket","$http",function(a,b,c,d){a.imageURL="http://pythontest-aritzbi.rhcloud.com",a.currentUser=b.currentUser(),d.get("http://pythontest-aritzbi.rhcloud.com/api/seriesCarousel").success(function(b){var b=b.results;a.slides=b,console.log(b)}),a.myInterval=5e3}]),angular.module("serieFrontendApp").controller("SeriesCtrl",["$scope","$http","Auth","$cookieStore",function(a,b,c,d){a.searchText="",a.imageURL="http://pythontest-aritzbi.rhcloud.com/",a.currentUser=c.currentUser(),b.get("http://pythontest-aritzbi.rhcloud.com/api/series").success(function(b){var b=b.results;if(console.log(b),a.currentUser)for(var c=0;c<b.length;c++)for(var d=b[c].favorited_by,e=!1,f=0;f<d.length&&!e;f++)d[f]==a.currentUser.id&&(b[c].favorited=!0,e=!0);a.series=b,console.log(b)}),a.addFavorite=function(c){var e={serie_id:c,user_id:a.currentUser.id};b.post("http://pythontest-aritzbi.rhcloud.com/api/addFavoriteSerie",e).success(function(b){console.log(b);for(var e=0;e<a.series.length;e++)a.series[e].id==c&&(a.series[e].favorited_by.push(a.currentUser.id),a.series[e].favorited=!0,d.remove("token"),a.currentUser.series.push(c),console.log(a.currentUser),d.put("token",a.currentUser),a.hasCalendar=!0)})},a.removeFavorite=function(c){var e={serie_id:c,user_id:a.currentUser.id};b.post("http://pythontest-aritzbi.rhcloud.com/api/removeFavoriteSerie",e).success(function(){for(var b=0;b<a.series.length;b++)if(a.series[b].id==c){var e=a.series[b].favorited_by.indexOf(a.currentUser.id);a.series[b].favorited_by.splice(e,1),a.series[b].favorited=!1,e=a.currentUser.series.indexOf(c),d.remove("token"),a.currentUser.series.splice(e,1),console.log(a.currentUser),d.put("token",a.currentUser)}})}}]),angular.module("serieFrontendApp").controller("EpisodesCtrl",["$scope","$http","$stateParams","$filter",function(a,b,c,d){a.imageURL="http://pythontest-aritzbi.rhcloud.com/",a.numberSeasons=0;var e=!1;a.currentPage=0;var f=d("orderBy");a.episodesBySeason=[],a.order=function(){a.episodes=f(a.episodes,"combined_episodenumber")},b.get("http://pythontest-aritzbi.rhcloud.com/api/episodes/"+c.id).success(function(b){a.episodes=b.results,console.log(b);for(var c=0;c<a.episodes.length;c++)a.episodes[c].combined_season=parseInt(a.episodes[c].combined_season),0==a.episodes[c].combined_season&&(e=!0),a.episodes[c].hasOverview=a.episodes[c].overview?!0:!1,a.episodes[c].combined_episodenumber=parseInt(a.episodes[c].combined_episodenumber),void 0==a.episodesBySeason[a.episodes[c].combined_season]&&(a.episodesBySeason[a.episodes[c].combined_season]=new Array,a.numberSeasons++),a.episodesBySeason[a.episodes[c].combined_season].push(a.episodes[c]);e&&(a.numberSeasons=a.numberSeasons-1),a.order()}),b.get("http://pythontest-aritzbi.rhcloud.com/api/series/"+c.id).success(function(b){a.serie=b.results[0],console.log(b)}),a.range=function(a,b){var c=[];b||(b=a,a=0);for(var d=a;b>d;d++)c.push(d);return c},a.prevPage=function(){a.currentPage>0&&a.currentPage--},a.nextPage=function(){a.currentPage<a.numberSeasons-1&&a.currentPage++},a.setPage=function(){a.currentPage=this.n,console.log(a.currentPage)},a.arePages=function(){return 0===a.filteredItems.length?!0:!1}}]),angular.module("serieFrontendApp").controller("EpisodeCtrl",["$scope","Auth","$state","$stateParams","$http",function(a,b,c,d,e){a.imageURL="http://pythontest-aritzbi.rhcloud.com/",a.currentUser=b.currentUser(),e.get("http://pythontest-aritzbi.rhcloud.com/api/episode/"+d._id).success(function(b){a.episode=b,a.episode.date=new Date(b.firstAired.$date),console.log(b)})}]),angular.module("serieFrontendApp").controller("LoginCtrl",["$scope","$http","GooglePlus","$cookieStore","Auth","$state","$location",function(a,b,c,d,e,f){a.currentUser=e.currentUser(),a.loginGoogle=function(){c.login().then(function(){c.getUser().then(function(a){var c={user_id:a.id};b.post("http://pythontest-aritzbi.rhcloud.com/api/registerUser",c).success(function(b){a.calendarID=b.calendarID,a.series=b.series,console.log(a.series),d.put("token",a),e.loginUser(),console.log(b),console.log(a),f.go("profile")})})},function(a){console.log(a)})}}]),angular.module("serieFrontendApp").controller("ProfileCtrl",["$scope","$http","GooglePlus","$cookieStore","Auth","$rootScope","$state",function(a,b,c,d,e,f,g){function h(b){var c=["https://www.googleapis.com/auth/plus.me","https://www.googleapis.com/auth/calendar"];gapi.client.setApiKey("AIzaSyCt0yTDMy4ks5yzHFD80wI9Pc-hQbDOrV4"),gapi.auth.authorize({client_id:"149439254149-9u3dae6ug4qjsl6blhplgeq5sjbh5od0.apps.googleusercontent.com",scope:c,immediate:!1},function(c){c&&!c.error?0==b?(a.mode=0,gapi.client.load("calendar","v3").then(i)):1==b?(a.mode=1,gapi.client.load("calendar","v3").then(j)):(a.mode=0,gapi.client.load("calendar","v3").then(j)):console.log(c.error)})}function i(){var c=gapi.client.calendar.calendars.insert({summary:"Series App Calendar"});c.then(function(c){c.body=JSON.parse(c.body),a.currentUser.calendarID=c.body.id,d.remove("token"),d.put("token",a.currentUser),a.hasCalendar=!0;var e={userID:a.currentUser.id,calendarID:a.currentUser.calendarID};b.post("http://pythontest-aritzbi.rhcloud.com/api/registerCalendar",e).success(function(c){console.log(c),1==a.mode&&b.get("http://pythontest-aritzbi.rhcloud.com/api/getFavoritesEpisodes/"+a.currentUser.id).success(function(a){a=a.results,l(0,a)})})},function(a){console.log("Error: "+a.result.error.message)})}function j(){var c=gapi.client.calendar.calendars["delete"]({calendarId:a.currentUser.calendarID});c.then(function(c){a.currentUser.calendarID=-1,a.hasCalendar=!1,d.remove("token"),d.put("token",a.currentUser);var e={userID:a.currentUser.id};b.post("http://pythontest-aritzbi.rhcloud.com/api/removeCalendar",e).success(function(b){console.log(b),1==a.mode&&gapi.client.load("calendar","v3").then(i)}),console.log(c)},function(a){console.log("Error: "+a.result.error.message)})}function k(a){function b(a){return 10>a?"0"+a:a}return a.getUTCFullYear()+"-"+b(a.getUTCMonth()+1)+"-"+b(a.getUTCDate())+"T"+b(a.getUTCHours())+":"+b(a.getUTCMinutes())+":"+b(a.getUTCSeconds())+"Z"}function l(b,c){if(void 0===b&&(b=0),!(b>=c.length)){console.log(c);var d=c[b].firstAired.$date,e=new Date(d);console.log(e),e=k(e),console.log(e);var f=new Date(d+36e5);f=k(f);var g=c[b].episode_name,h=c[b].serie_name;console.log(d),console.log(g),gapi.client.load("calendar","v3",function(){console.log(e),console.log(g);var d=gapi.client.calendar.events.insert({end:{dateTime:f},start:{dateTime:e},description:h+": "+g,calendarId:a.currentUser.calendarID,summary:h+": "+g});d.then(function(a){console.log(a)},function(a){console.log("Error: "+a.result.error.message)}),b++,l(b,c)})}}a.currentUser=e.currentUser(),a.currentPage=0,console.log(a.currentUser),-1!=a.currentUser.calendarID?(console.log(a.currentUser.calendarID),a.hasCalendar=!0):a.hasCalendar=!1,a.useAPI=function(a){h(a)},a.logout=function(){e.logout(),g.go("home")}}]),angular.module("serieFrontendApp").controller("FavoritesCtrl",["$scope","$http","Auth",function(a,b,c){a.currentUser=c.currentUser(),a.searchText="",a.imageURL="http://pythontest-aritzbi.rhcloud.com/",b.get("http://pythontest-aritzbi.rhcloud.com/api/getFavorites/"+a.currentUser.id).success(function(b){var b=b.results;if(a.currentUser)for(var c=0;c<b.length;c++)for(var d=b[c].favorited_by,e=!1,f=0;f<d.length&&!e;f++)d[f]==a.currentUser.id&&(b[c].favorited=!0,e=!0);console.log(b),a.series=b}),b.get("http://pythontest-aritzbi.rhcloud.com/api/getTimeForFavorites/"+a.currentUser.id).success(function(a){console.log(a)}),a.checkCalendar=function(){}}]),angular.module("serieFrontendApp").controller("NavbarCtrl",["$scope","$location","Auth","mySocket","ngToast","$timeout",function(a,b,c,d,e){a.isActive=function(a){return a===b.path()},d.on("socket:notification",function(b){if(console.log(b),b=JSON.parse(b),void 0!=a.currentUser)for(var c=0;c<b.length;c++)-1!=a.currentUser.series.indexOf(b[c].serie_id)&&(console.log(b[c].serie_name),e.create({content:"<strong>"+b[c].serie_name+"</strong>, episode "+b[c].episode_name+" starts in "+f(b[c].dif),dismissOnTimeout:!1,dismissButton:!0,dismissOnClick:!1}));else console.log("No User logged")});var f=function(a){var b=Math.floor(a/3600);a-=3600*b;var c=Math.floor(a/60);return b+" hours and "+c+" minutes"}}]),angular.module("serieFrontendApp").factory("Auth",["$rootScope","$cookieStore",function(a,b){return a.currentUser=b.get("token")||null,console.log(a.currentUser),{logout:function(c){c||angular.noop;a.currentUser=null,b.remove("token")},isLoggedIn:function(){console.log("llamo");var b=a.currentUser;return!!b},currentUser:function(){return a.currentUser},loginUser:function(){a.currentUser=b.get("token")||null}}}]);